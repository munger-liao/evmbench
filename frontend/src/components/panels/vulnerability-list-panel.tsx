"use client"

import { Bug01Icon, Download04Icon } from "@hugeicons/core-free-icons"
import { HugeiconsIcon } from "@hugeicons/react"
import { useMemo, useRef } from "react"
import { InlineMarkdown } from "@/components/markdown"
import { ScrollArea } from "@/components/ui/scroll-area"
import {
  downloadAllVulnerabilities,
  downloadVulnerability,
} from "@/lib/download-vulnerabilities"
import { useScrollIntoView } from "@/hooks/use-scroll-into-view"
import { cn } from "@/lib/utils"
import { sortVulnerabilitiesBySeverity } from "@/lib/vulnerabilities"
import { SEVERITY_CONFIG, type Vulnerability } from "@/types"
import { PanelHeader } from "./panel-header"

interface VulnerabilityListPanelProps {
  isCollapsed?: boolean
  onToggleCollapse?: () => void
  showCollapseToggle?: boolean
  vulnerabilities: Vulnerability[]
  selectedVulnerability: Vulnerability | null
  onSelectVulnerability: (vuln: Vulnerability) => void
  scrollToVulnerabilityId?: string | null
  jobId?: string | null
}

export function VulnerabilityListPanel({
  isCollapsed = false,
  onToggleCollapse,
  showCollapseToggle = true,
  vulnerabilities,
  selectedVulnerability,
  onSelectVulnerability,
  scrollToVulnerabilityId,
  jobId,
}: VulnerabilityListPanelProps) {
  const listRef = useRef<HTMLDivElement>(null)

  const scrollTarget = scrollToVulnerabilityId
    ? `[data-vulnerability-id="${CSS.escape(scrollToVulnerabilityId)}"]`
    : null
  useScrollIntoView(listRef, scrollTarget)
  const sortedVulnerabilities = useMemo(
    () => sortVulnerabilitiesBySeverity(vulnerabilities),
    [vulnerabilities],
  )

  return (
    <div className="flex h-full min-w-0 flex-col overflow-hidden my-1.5 lg:my-0">
      <div className="flex items-center justify-between">
        <PanelHeader
          icon={Bug01Icon}
          title="Vulnerabilities"
          count={sortedVulnerabilities.length}
          isCollapsed={isCollapsed}
          onToggleCollapse={onToggleCollapse}
          showCollapseToggle={showCollapseToggle}
        />
        {!isCollapsed && sortedVulnerabilities.length > 0 && (
          <button
            type="button"
            onClick={() =>
              downloadAllVulnerabilities(sortedVulnerabilities, jobId ?? undefined)
            }
            className="mr-2 flex items-center gap-1 rounded px-1.5 py-0.5 text-xs text-muted-foreground hover:bg-muted/50 hover:text-foreground"
            title="Download all vulnerabilities"
          >
            <HugeiconsIcon icon={Download04Icon} size={14} />
            <span>All</span>
          </button>
        )}
      </div>
      {!isCollapsed && (
        <ScrollArea className="min-w-0 flex-1 mt-1.5 max-h-48 md:max-h-none">
          <div ref={listRef} className="px-2">
            {sortedVulnerabilities.length === 0 ? (
              <div className="px-2 text-xs text-muted-foreground">
                No vulnerabilities reported yet.
              </div>
            ) : (
              sortedVulnerabilities.map((vuln) => (
                <div
                  key={vuln.id}
                  data-vulnerability-id={vuln.id}
                  className={cn(
                    "group flex min-w-0 w-full items-start gap-2 rounded-sm px-2 py-0.5 text-left text-sm hover:bg-muted/50",
                    selectedVulnerability?.id === vuln.id &&
                      "inset-ring-1 inset-ring-border bg-muted/50",
                  )}
                >
                  <button
                    type="button"
                    onClick={() => onSelectVulnerability(vuln)}
                    className="flex min-w-0 flex-1 items-start gap-2"
                  >
                    <span className="shrink-0 whitespace-nowrap pt-0.5 tabular-nums text-xs text-muted-foreground">
                      {vuln.id}
                    </span>
                    <span
                      className={cn(
                        "mt-1.5 size-2 shrink-0 rounded-full",
                        SEVERITY_CONFIG[vuln.severity].bgForeground,
                      )}
                    />
                    <span className="min-w-0 text-foreground/80">
                      <InlineMarkdown>{vuln.title}</InlineMarkdown>
                    </span>
                  </button>
                  <button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation()
                      downloadVulnerability(vuln)
                    }}
                    className="shrink-0 p-0.5 text-muted-foreground opacity-0 hover:text-foreground group-hover:opacity-100"
                    title="Download this vulnerability"
                  >
                    <HugeiconsIcon icon={Download04Icon} size={14} />
                  </button>
                </div>
              ))
            )}
          </div>
        </ScrollArea>
      )}
    </div>
  )
}
